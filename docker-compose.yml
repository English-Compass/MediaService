version: '3.8'

services:
  app:
    build: .
    container_name: middle-point-app
    ports:
      - "8084:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      # Gemini API Credentials
      - GCP_PROJECT_ID=gcp-project-id-placeholder
      - GEMINI_API_KEY=AIzaSyAzD2lThmfu03qOfd0Pc6K73AFi797c2Z4
      # MySQL 연결 (db 컨테이너)
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/mediadb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
      - SPRING_DATASOURCE_USERNAME=mediauser
      - SPRING_DATASOURCE_PASSWORD=mediapass
      # Redis 연결 (redis 컨테이너)
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      # Kafka 연결 (kafka 컨테이너)
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      # 서버 포트 설정
      - SPRING_SERVER_PORT=8084
      # 외부 API 키
      - KAKAO_API_KEY=${KAKAO_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    depends_on:
      - db
      - redis
      - kafka
    networks:
      - kdt-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  db:
    image: mysql:8.0
    container_name: middle-point-mysql
    environment:
      - MYSQL_DATABASE=mediadb
      - MYSQL_USER=mediauser
      - MYSQL_PASSWORD=mediapass
      - MYSQL_ROOT_PASSWORD=rootpass
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - kdt-network
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: middle-point-redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - kdt-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s



  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: middle-point-kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    ports:
      - "29093:29092"
    depends_on:
      - zookeeper
    networks:
      - kdt-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: middle-point-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2182:2181"
    networks:
      - kdt-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s



volumes:
  mysql_data:
  redis_data:

networks:
  kdt-network:
    driver: bridge
